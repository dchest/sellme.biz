#
#  Config for TOR hidden service: sellmefmabkgispl.onion
#

server {
	listen		8333; # Tor hidden service is bound to this port.
	server_name	sellmefmabkgispl.onion;
	server_tokens	off;
	root		/var/www/sellme.biz;
	
	# Turn off access logging for privacy.
	access_log	off;

	# Redirect www to non-www.
	if ($host ~* ^www\.){
		rewrite ^(.*)$ $scheme://sellmefmabkgispl.onion$1;
	}

	#
	# Basics
	# ------
	#

	# Index
	index index.html index.htm;

	# 404 error
	error_page 404 /404.html;

	# Redirect feed.
	rewrite ^/feed/?$ $scheme://$host/atom.xml redirect;

	#
	# Cool URIs Don't Change.
	# (But when they change, we redirect.)
	# ------------------------------------
	#
	set $new_url "http://sellmefmabkgispl.onion";


	# Sellme ran on multiple CMS since 2005. We'd like to keep links working.

	# WordPress
	#
	# Links were in the form of /YYYY/MM/DD/post_name/
	#
	# To get the current scheme, we remove day, append .html and replace
	# underscore with dashes: /YYYY/MM/post-name.html
	# But first we try .html.
	rewrite "^/([0-9]{4})/([0-9]{2})/([0-9]{2})/([^/]+)\.html$"	$new_url/$1/$2/$4.html	permanent;
	rewrite "^/([0-9]{4})/([0-9]{2})/([0-9]{2})/([^/]+)/?$"	$new_url/$1/$2/$4.html	permanent;
	# replace underscores with dashes (it will continue replacing until all done):
	rewrite "^/([0-9]{4})/([0-9]{2})/(.*)\_(.*)$" 		$new_url/$1/$2/$3-$4	permanent;
	# upload
	rewrite "^/wp-content/uploads/(.*)$"	$new_url/pics/$1	permanent;

	# Old
	rewrite "^/old/(.*)$"	$new_url/$1 permanent;

	# Webby
	#
	# Published only a few articles with Webby, redirect them.
	#
	rewrite ^/articles/essense.html$                 $new_url/2009/08/essense.html                  permanent;
	rewrite ^/articles/tableview-browsing.html$      $new_url/2009/04/tableview-browsing.html       permanent;
	rewrite ^/articles/ellipticlicense-preview.html$ $new_url/2009/03/ellipticlicense-preview.html  permanent;
	rewrite ^/articles/mosso-cloud-servers.html$     $new_url/2009/03/mosso-cloud-servers.html      permanent;
	rewrite ^/articles/change.html$	                 $new_url/2009/03/change.html                   permanent;

	# Site pages.
	rewrite ^/about/$		$new_url/about.html permanent;
	rewrite ^/contacts/$		$new_url/about.html permanent;
	rewrite ^/contacts.html$	$new_url/about.html permanent;

	# Password page. (Not recommended for use anymore).
	rewrite ^/p/?$	$new_url/password/password.html	  permanent;
	rewrite ^/p2/?$ $new_url/password2/password2.html permanent;
	rewrite ^/pi/?$ $new_url/password2/ios.html	  permanent;

	# Removed posts.
	#
	# Sometimes the information contained in posts becomes obsolete
	# and it's better addressed by some third-party website.
	#
	rewrite ^/2005/07/kak-poluchit-inn-fizicheskomu-litsu.html$ http://nalog.ru permanent;

	#
	# Optimizations
	# -------------
	#

	# Enable gzip compression
	# XXX must be enabled by default

	# Images expire in 30 days.
	location ~* \.(?:ico|gif|jpe?g|png)$ {
		expires	   30d;
		add_header Cache-Control public;
	}

	# Pages expire in 1 hour.
	location ~* \.(?:xml|txt|html|htm)$ {
		expires	   1h;
		add_header Cache-Control public;
	}

	# Assets and fonts never expire.
	location /assets {
		expires    max;
		add_header Cache-Control public;
	}

	location /fonts {
		expires    max;
		add_header Cache-Control public;
	}
}

