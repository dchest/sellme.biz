server {
	listen 	80;
	server_name	sellme.ru sellme.biz;
	server_tokens	off;

	# Redirect sellme.ru to sellme.biz.
	if ($http_user_agent ~* (FeedBurner|YandexBot|bingbot)) {
		return 301 http://sellme.biz$request_uri;
	}
	return 301 https://sellme.biz$request_uri;
}

server {
	listen		80;
	listen		443 ssl;
	listen          8333; # Tor hidden service is bound to this port.
	server_name	sellme.biz sellmefmabkgispl.onion sellme.dev;
	server_tokens	off;
	root            /var/www/sellme.biz;

	# Turn access logging. For privacy.
	access_log	off;

	#
	# TLS config based on Mozilla's recommentation:
	# at https://wiki.mozilla.org/Security/Server_Side_TLS#Nginx
	# (except for OCSP Stapling).
	#
	ssl_certificate			/etc/nginx/ssl/sellme.biz.crt;
	ssl_certificate_key		/etc/nginx/ssl/sellme.biz.key;
	ssl_dhparam			/etc/nginx/ssl/oakley-group-14.pem;
	ssl_session_timeout		5m;
	ssl_protocols 			SSLv3 TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK';
	ssl_prefer_server_ciphers	on;
	ssl_session_cache		shared:SSL:50m;

	# Redirect www to non-www.
	if ($host ~* ^www\.){
		rewrite ^(.*)$ $scheme://sellme.biz$1;
	}

	#
	# RSS Feed: redirect to FeedBurner.
	#
	# Must come before HTTPS redirection, since a lot of
	# feed readers can't handle TLS.
	#
	if ($http_user_agent !~ FeedBurner) {
		rewrite ^/rss/?$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/rss/?(.*)/?$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/feed/?$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/feed/?(.*)/?$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/wp-rss2.php$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/wp-atom.php$	http://feeds.feedburner.com/SellMe redirect;
		rewrite ^/category/podcasts/feed/?(.*)$ http://feeds.feedburner.com/SellMe redirect;
	}

	# Redirect to HTTPS everyone except for Tor and bots that can't HTTPS.
	if ($scheme = "http") {  # XXX alternative ($server_port = 80)
		set $redir_to_https "yes";
	}
	if ($host ~* .(onion|dev)$) {
		set $redir_to_https "no";
	}
	if ($http_user_agent ~* (FeedBurner|YandexBot|bingbot)) {
		set $redir_to_https "no";
	}
	if ($redir_to_https = "yes") {
		return 301 https://$host$request_uri;
	}
	# ... the rest of config ...

	#
	# Block Russian Government's related networks.
	# See https://github.com/AntiZapret/antizapret
	#
	deny 62.117.66.160/29;
	deny 78.108.192.0/20;
	deny 81.176.0.0/16;
	deny 85.142.52.0/24;
	deny 91.190.236.0/22;
	deny 91.224.182.0/23;
	deny 91.227.32.0/24;
	deny 91.236.22.0/23;
	deny 92.39.133.160/28;
	deny 94.199.64.0/21;
	deny 95.173.128.0/19;
	deny 109.207.0.0/20;
	deny 178.248.232.0/21;
	deny 178.237.206.0/24;
	deny 178.237.240.0/20;
	deny 193.105.14.0/24;
	deny 193.27.214.0/23;
	deny 193.47.146.0/24;
	deny 194.150.202.0/23;
	deny 194.165.22.0/23;
	deny 194.190.89.0/24;
	deny 194.226.22.0/23;
	deny 194.226.80.0/20;
	deny 194.226.116.0/22;
	deny 194.226.127.0/24;
	deny 194.85.30.0/24;
	deny 195.149.110.0/24;
	deny 212.42.32.0/19;
	deny 213.24.76.0/23;
	deny 89.108.112.0/20;
	deny 89.111.176.0/20;
	deny 91.219.192.0/22;
	deny 184.82.0.0/16;
	deny 194.85.88.0/23;
	deny 195.128.157.0/24;
	deny 213.232.192.0/18;

	#
	# Basics
	# ------
	#

	# Index
	index index.html index.htm;

	# 404 error
	error_page 404 /404.html;

	#
	# Cool URIs Don't Change.
	# (But when they change, we redirect.)
	# ------------------------------------
	#

	# Sellme ran on multiple CMS since 2005. We'd like to keep links working.

	# WordPress
	#
	# Links were in the form of /YYYY/MM/DD/post_name/
	#
	# To get the current scheme, we remove day, append .html and replace
	# underscore with dashes: /YYYY/MM/post-name.html
	#
	rewrite "^/([0-9]{4})/([0-9]{2})/([0-9]{2})/([^/]+)/?$"	/$1/$2/$4.html	permanent;
	# replace underscores with dashes (it will continue replacing until all done):
	rewrite "^/([0-9]{4})/([0-9]{2})/(.*)\_(.*)$" 		/$1/$2/$3-$4	permanent;
	# upload
	rewrite ^/wp-content/uploads/(.*)$	/pics/$1	permanent;

	# Webby
	#
	# Published only a few articles with Webby, redirect them.
	#
	rewrite ^/articles/essense.html$                 /2009/08/essense.html                  permanent;
	rewrite ^/articles/tableview-browsing.html$      /2009/04/tableview-browsing.html       permanent;
	rewrite ^/articles/ellipticlicense-preview.html$ /2009/03/ellipticlicense-preview.html  permanent;
	rewrite ^/articles/mosso-cloud-servers.html$     /2009/03/mosso-cloud-servers.html      permanent;
	rewrite ^/articles/change.html$	                 /2009/03/change.html                   permanent;

	# Site pages.
	rewrite ^/about/$		/about.html permanent;
	rewrite ^/contacts/$		/about.html permanent;
	rewrite ^/contacts.html$	/about.html permanent;

	# Password page. (Not recommended for use anymore).
	rewrite ^/p/?$	/password/password.html	  permanent;
	rewrite ^/p2/?$ /password2/password2.html permanent;
	rewrite ^/pi/?$ /password2/ios.html	  permanent;

	# Removed posts.
	#
	# Sometimes the information contained in posts becomes obsolete
	# and it's better addressed by some third-party website.
	#
	rewrite ^/2005/07/kak-poluchit-inn-fizicheskomu-litsu.html$ http://nalog.ru permanent;

	#
	# Optimizations
	# -------------
	#

	# Enable gzip compression
	# XXX must be enabled by default

	# Images expire in 30 days.
	location ~* \.(?:ico|gif|jpe?g|png)$ {
		expires	   30d;
		add_header Cache-Control public;
	}

	# Pages expire in 1 hour.
	location ~* \.(?:xml|txt|html|htm)$ {
		expires	   1h;
		add_header Cache-Control public;
	}

	# Assets and fonts never expire.
	location /assets {
		expires    max;
		add_header Cache-Control public;
	}

	location /fonts {
		expires    max;
		add_header Cache-Control public;
	}
}
